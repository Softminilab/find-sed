# !bin/bash
 
# éœ€è¦æ›´æ”¹ new_name å­—æ®µå’Œ project_name project_nameå¯ä»¥ä½¿ç”¨ xcodebuild -list è·å–scheme

SECONDS=0
originProject_name=`find . -name *.xcodeproj | awk -F "[/.]" '{print $(NF-1)}'`
infoPlistDic=./$originProject_name/Info.plist
# dateTime=`date +%Y%m%d` %H:%M:%S 
name_prefix="ShellBaleAutoUpload"
new_name=${name_prefix}
echo $new_name

origin_Name=`/usr/libexec/PlistBuddy -c "Print CFBundleDisplayName" $infoPlistDic`
version=`/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" $infoPlistDic`
scheme=`/usr/libexec/PlistBuddy -c "Print RootSchemes" $infoPlistDic`

echo "\033[36m ~~~~~~~~~~~~~~~~~~~~~~~"
echo "\033[36m App nameï¼š${new_name}"
echo "\033[36m App versionï¼š${version}"
echo "\033[36m ~~~~~~~~~~~~~~~~~~~~~~~\n"

if [ -e $infoPlistDic ] ; then
sed -i '' 's/'${origin_Name}'/'${new_name}'/g' $infoPlistDic
else
	exit 0
fi

project_name=$scheme
scheme_name=$scheme
build_configuration="Release"
archive_name=${new_name}

if [ -d ${archive_name} ] ; then
rm -rf $archive_name
fi

mkdir $archive_name

archive_dir=./${archive_name}
exportPlist=$HOME/Documents/SH/dabao/AdHocExportOptionsPlist.plist
xcarchiveDir=$archive_dir/${new_name}.xcarchive

echo "\033[32m~~~~~~~~~~ æ¸…ç†é¡¹ç›® ~~~~~~~~~~~~~\n"

xcodebuild clean -workspace ${project_name}.xcworkspace \
                 -scheme ${scheme_name} \
                 -configuration ${build_configuration} > /dev/null 2>&1


echo "\033[32m~~~~~~~~~~ æ¸…ç†å®Œæˆ ~~~~~~~~~~~~~\n"


echo 
echo "\033[35m~~~~~~~~~~ æ‰“åŒ…å¼€å§‹ ~~~~~~~~~~~~~ \n"
echo

xcodebuild archive -workspace ${project_name}.xcworkspace \
-scheme ${scheme_name} \
-configuration ${build_configuration} \
-archivePath ${xcarchiveDir} > /dev/null 2>&1

if [ -d "$xcarchiveDir" ] ; then
echo 
echo "\033[32m~~~~~~~~~~ æ‰“åŒ…æˆåŠŸ ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰ ~~~~~~~~~~~~~\n"
else
echo 
echo "\033[31m~~~~~~~~~~ æ‰“åŒ…å¤±è´¥ ~~~~~~~~~~~~~\n"
exit 0
echo 
fi

echo "\033[35m~~~~~~~~~~ å¯¼æˆ ipa ~~~~~~~~~~~~~\n"

xcodebuild  -exportArchive \
            -archivePath ${xcarchiveDir} \
            -exportPath ${archive_dir} \
            -exportOptionsPlist ${exportPlist} > /dev/null 2>&1

path=${archive_name}/${scheme_name}.ipa
replacepath=${archive_name}/${new_name}.ipa

if [ -f $path ] ; then
mv $path $replacepath
echo "\033[32m~~~~~~~~~~ å¯¼æˆipaæˆåŠŸ ~~~~~~~~~~~~~\n"
else 
echo "\033[31m~~~~~~~~~~ å¯¼æˆipaå¤±è´¥ ~~~~~~~~~~~~~\n"
exit 0
fi 
echo "\033[36;1mæ‰“åŒ…æ€»ç”¨æ—¶: ${SECONDS}s \033[0m"


echo "\033[32m~~~~~~~~~~ ä¸Šä¼ æœåŠ¡å™¨ ~~~~~~~~~~~~~\n"




